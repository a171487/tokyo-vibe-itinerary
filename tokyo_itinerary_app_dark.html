<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOKYO VIBE | 鮮明配色儀表板</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* 品牌配色定義 */
        :root {
            --color-dark-navy: #1D2A35;
            --color-cream: #F7FCF5;
            --color-teal: #2CBBAD;
            --color-red: #D83D4F;
        }

        /* 全局樣式：深色基底，淺色字體 */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--color-dark-navy); 
            color: var(--color-cream);
            min-height: 100vh;
        }

        /* 主要卡片面板 - 使用淺色搭配深色邊框和陰影，實現高對比 */
        .flat-panel {
            background-color: var(--color-cream); /* 淺色卡片 */
            color: var(--color-dark-navy); /* 卡片內使用深色文字 */
            border: 1px solid rgba(44, 187, 173, 0.2); /* 淡淡的邊框 */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08); /* 柔和陰影 */
        }
        
        /* 品牌色按鈕 - 強調色 (Teal) */
        .btn-primary {
            background-color: var(--color-teal);
            color: var(--color-cream);
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-primary:hover {
            background-color: #24A397; /* 稍微深一點的 Teal */
            transform: translateY(-1px);
        }
        .btn-primary:active {
            transform: translateY(0);
        }

        /* 警告/行動按鈕 - 強調色 (Red) */
        .btn-danger {
            background-color: var(--color-red);
            color: var(--color-cream);
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-danger:hover {
            background-color: #C03544;
            transform: translateY(-1px);
        }

        /* 導航按鈕 */
        .nav-button {
            transition: color 0.2s, background-color 0.2s;
            cursor: pointer;
        }
        .nav-button:hover {
            color: var(--color-teal);
        }
        .nav-button.active {
            color: var(--color-teal);
            border-bottom: 2px solid var(--color-teal);
        }

        /* 焦點樣式 */
        .teal-accent {
            background-color: rgba(44, 187, 173, 0.2); /* 帶有透明度的 Teal 背景 */
            color: var(--color-teal);
            font-weight: 600;
        }
        .red-accent {
            background-color: rgba(216, 61, 79, 0.2); /* 帶有透明度的 Red 背景 */
            color: var(--color-red);
            font-weight: 600;
        }
        
        /* 隱藏原生捲軸 */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-7xl mx-auto">
        <!-- 頂部導航與標題 -->
        <header class="mb-8">
            <h1 class="text-4xl md:text-5xl font-extrabold text-white tracking-tight mb-2">
                TOKYO VIBE <span class="text-3xl font-medium text-teal-400">| 東京旅程儀表板</span>
            </h1>
            <p id="h-addr" class="text-sm font-mono text-gray-400 cursor-pointer" onclick="copyAddress()">請點擊下方按鈕設定地址</p>
        </header>

        <!-- 主要佈局：兩欄 -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- 左側：控制面板 / 快速資訊 (佔 1/3) -->
            <section class="lg:col-span-1 space-y-6">
                
                <!-- 飯店資訊與地址 -->
                <div class="flat-panel p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-3 flex items-center">
                        <i data-lucide="building-2" class="w-5 h-5 mr-2"></i>
                        飯店資訊
                    </h2>
                    <p id="h-name" class="text-xl font-extrabold mb-1">... 載入中 ...</p>
                    <p id="h-dates" class="text-sm text-gray-500 mb-3">...</p>
                    <button class="btn-primary w-full py-2 rounded-lg text-sm font-semibold shadow-md mt-2" onclick="showHotelModal()">
                        <i data-lucide="settings" class="w-4 h-4 mr-2 inline-block"></i>
                        設定飯店/地址
                    </button>
                    <!-- 地址複製按鈕，但主要複製邏輯在 h-addr 的 onclick -->
                    <button class="btn-primary w-full py-2 rounded-lg text-sm font-semibold shadow-md mt-2 hidden" id="copy-addr-btn" onclick="copyAddress()">
                        <i data-lucide="copy" class="w-4 h-4 mr-2 inline-block"></i>
                        複製地址
                    </button>
                </div>

                <!-- 匯率轉換器 -->
                <div class="flat-panel p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-3 flex items-center">
                        <i data-lucide="trending-up" class="w-5 h-5 mr-2"></i>
                        匯率轉換器 (TWD 兌 JPY)
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <label for="twdInput" class="block text-xs font-medium text-gray-500">台幣 (TWD)</label>
                            <input type="number" id="twdInput" oninput="convertCurrency(this.value, 'twd')" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150">
                        </div>
                        <div class="text-center font-bold text-gray-600">
                            <i data-lucide="arrow-down-up" class="w-5 h-5 inline-block"></i>
                        </div>
                        <div>
                            <label for="jpyInput" class="block text-xs font-medium text-gray-500">日圓 (JPY)</label>
                            <input type="number" id="jpyInput" oninput="convertCurrency(this.value, 'jpy')" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150">
                        </div>
                    </div>
                    <p id="rateInfo" class="text-sm text-gray-500 mt-3 text-center">當前匯率: 1 TWD = 4.60 JPY</p>
                    <button class="btn-primary w-full py-2 rounded-lg text-sm font-semibold shadow-md mt-3" onclick="showRateModal()">
                        <i data-lucide="calculator" class="w-4 h-4 mr-2 inline-block"></i>
                        設定匯率
                    </button>
                </div>

                <!-- 購物清單摘要 (快速入口) -->
                <div class="flat-panel p-6 rounded-xl shadow-lg">
                    <h2 class="text-xl font-bold mb-3 flex items-center">
                        <i data-lucide="shopping-bag" class="w-5 h-5 mr-2"></i>
                        待辦清單 (共 <span id="pending-count" class="font-extrabold text-teal-500 ml-1">0</span> 項)
                    </h2>
                    <ul id="shopping-list-summary" class="space-y-1 text-sm text-gray-700">
                        <!-- 摘要項目將由 JS 填充 -->
                        <li class="text-gray-500 text-center py-2">清單為空</li>
                    </ul>
                    <button class="btn-primary w-full py-2 rounded-lg text-sm font-semibold shadow-md mt-4" onclick="setView('SHOPPING')">
                        <i data-lucide="list-checks" class="w-4 h-4 mr-2 inline-block"></i>
                        管理完整清單
                    </button>
                </div>

            </section>

            <!-- 右側：主要內容區 (佔 2/3) -->
            <section class="lg:col-span-2 space-y-6">
                
                <!-- 導航列 -->
                <nav class="flex space-x-4 border-b border-gray-700/50 text-gray-400">
                    <button id="btnItinerary" class="nav-button pb-3 px-2 text-base font-semibold active" onclick="setView('ITINERARY')">
                        <i data-lucide="calendar-check" class="w-5 h-5 mr-1 inline-block"></i> 行程總覽
                    </button>
                    <button id="btnShopping" class="nav-button pb-3 px-2 text-base font-semibold" onclick="setView('SHOPPING')">
                        <i data-lucide="shopping-cart" class="w-5 h-5 mr-1 inline-block"></i> 購物清單
                    </button>
                    <button id="btnNotes" class="nav-button pb-3 px-2 text-base font-semibold" onclick="setView('NOTES')">
                        <i data-lucide="sticky-note" class="w-5 h-5 mr-1 inline-block"></i> 旅遊筆記
                    </button>
                </nav>

                <!-- 內容容器 -->
                <div id="main-content" class="min-h-[60vh] bg-gray-800/20 p-6 rounded-xl shadow-xl transition-all duration-300">
                    <!-- 內容將由 JS 渲染 -->
                    <p class="text-gray-500 text-center py-10">載入中...</p>
                </div>

            </section>
        </main>
    </div>

    <!-- Modal 容器 -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden transition-opacity duration-300 opacity-0">
        <!-- Modal 內容將由 JS 填充 -->
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase 登錄級別為 Debug
        setLogLevel('Debug');

        // 全局變數
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-tokyo-vibe-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // 預設為匿名
        let isAuthReady = false;

        // 應用程式數據模型
        let hotel = {
            name: '請設定飯店名稱',
            address: '請點擊下方按鈕設定地址',
            dates: 'YYYY/MM/DD - YYYY/MM/DD',
            rate: 4.60 // 1 TWD = 4.60 JPY
        };
        let itinerary = [
            // 範例行程 (Day 1)
            {
                day: 1,
                date: '4/25 (四)',
                activities: [
                    { time: '10:00', description: '抵達東京成田/羽田機場' },
                    { time: '13:00', description: '飯店Check-in' },
                    { time: '15:00', description: '淺草寺、仲見世通 (雷門)' },
                    { time: '18:00', description: '晚餐：一蘭拉麵 (上野店)' },
                    { time: '20:00', description: '多慶屋購物' }
                ]
            },
            // 範例行程 (Day 2)
            {
                day: 2,
                date: '4/26 (五)',
                activities: [
                    { time: '09:00', description: '築地市場' },
                    { time: '13:00', description: '銀座購物 (UNIQLO旗艦店)' },
                    { time: '18:00', description: '晚餐：燒肉放題' }
                ]
            }
        ];
        // 購物清單 (public data)
        let shoppingList = [];
        // 旅遊筆記 (private data)
        let notes = '';

        let appView = 'ITINERARY'; // 當前視圖: ITINERARY, SHOPPING, NOTES
        let itineraryDay = 1; // 當前行程頁面，預設 Day 1

        // ===== Firebase 初始化與身份驗證 =====

        const initializeFirebase = async () => {
            try {
                if (!firebaseConfig || Object.keys(firebaseConfig).length === 0) {
                    console.warn("Firebase config is missing or empty. Running as local mode.");
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 嘗試使用自定義 token 登入
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Firebase 認證成功，User ID:", userId);
                    } else {
                        userId = 'anonymous';
                        console.log("Firebase 處於匿名/未登入狀態。");
                    }
                    isAuthReady = true;
                    // 在認證就緒後載入所有資料並啟動監聽
                    loadDataListeners(); 
                });

            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
            }
        };

        // ===== 資料庫操作與即時監聽 (Snapshot Listeners) =====

        // 構建公開資料路徑: /artifacts/{appId}/public/data/{collectionName}
        const getPublicCollectionPath = (collectionName) => {
            return `artifacts/${appId}/public/data/${collectionName}`;
        }

        // 構建私人資料路徑: /artifacts/{appId}/users/{userId}/{collectionName}
        const getPrivateDocPath = (docId) => {
            return `artifacts/${appId}/users/${userId}/config/${docId}`;
        }
        
        // 載入所有資料的即時監聽器
        const loadDataListeners = () => {
            if (!isAuthReady) return;

            // 1. Hotel & Rate (私人資料 - doc)
            const hotelDocRef = doc(db, getPrivateDocPath('hotel'));
            onSnapshot(hotelDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    hotel = docSnap.data();
                } else {
                    console.log("飯店/匯率配置不存在，使用預設值。");
                    // 確保預設值被存入以供後續編輯
                    saveHotel(false); 
                }
                updateHotelUI();
                convertCurrency(document.getElementById('twdInput')?.value || 0, 'twd', false); // 重新計算匯率
            }, (error) => {
                console.error("監聽飯店/匯率配置失敗:", error);
            });
            
            // 2. Shopping List (公開資料 - collection)
            // 由於 firestore orderBy 可能需要索引，我們將在客戶端進行排序
            const shoppingColRef = collection(db, getPublicCollectionPath('shoppingList'));
            onSnapshot(shoppingColRef, (snapshot) => {
                shoppingList = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // 避免 orderBy 導致的錯誤，從 data 中讀取 'timestamp' 或使用 createdAt
                    shoppingList.push({ id: doc.id, ...data });
                });
                
                // 在客戶端進行排序 (例如：未購買的在前，然後按名稱排序)
                shoppingList.sort((a, b) => {
                    if (a.purchased !== b.purchased) {
                        return a.purchased ? 1 : -1; // false (未購買) 在前
                    }
                    // 其次按名稱排序 (中文/英文)
                    return a.name.localeCompare(b.name, 'zh-TW');
                });

                renderShoppingList();
                updateShoppingSummary();
            }, (error) => {
                console.error("監聽購物清單失敗:", error);
            });

            // 3. Notes (私人資料 - doc)
            const notesDocRef = doc(db, getPrivateDocPath('notes'));
            onSnapshot(notesDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    notes = docSnap.data().content || '';
                } else {
                    notes = ''; // 預設值
                }
                if (appView === 'NOTES') {
                    renderNotes();
                }
            }, (error) => {
                console.error("監聽旅遊筆記失敗:", error);
            });
        };

        // 儲存飯店/匯率資訊
        const saveHotel = async (showFeedback = true) => {
            if (!isAuthReady || userId === 'anonymous') {
                console.warn("認證未就緒或匿名用戶，無法儲存。");
                return;
            }
            try {
                const hotelDocRef = doc(db, getPrivateDocPath('hotel'));
                await setDoc(hotelDocRef, hotel, { merge: true });
                if (showFeedback) {
                    showModal('飯店/匯率資訊已成功儲存！', 'success');
                }
            } catch (e) {
                console.error("儲存飯店/匯率失敗:", e);
                showModal('儲存飯店/匯率失敗，請檢查連線。', 'error');
            }
        };

        // 新增購物清單項目
        const addShoppingItem = async (name) => {
            if (!isAuthReady || userId === 'anonymous') {
                showModal('請先登入或等待初始化完成。', 'warning');
                return;
            }
            if (!name.trim()) return;
            try {
                const shoppingColRef = collection(db, getPublicCollectionPath('shoppingList'));
                // 使用 addDoc 讓 Firestore 自動生成 ID
                await setDoc(doc(shoppingColRef), {
                    name: name.trim(),
                    purchased: false,
                    // 不使用伺服器時間戳，避免潛在的索引問題
                    createdAt: Date.now(), 
                    userId: userId 
                });
                
            } catch (e) {
                console.error("新增購物項目失敗:", e);
                showModal('新增項目失敗，請檢查連線。', 'error');
            }
        };

        // 切換購物清單項目狀態
        window.toggleShoppingItem = async (index) => {
            if (!isAuthReady || userId === 'anonymous') {
                showModal('請先登入或等待初始化完成。', 'warning');
                return;
            }
            if (!shoppingList[index]) return;
            
            try {
                const item = shoppingList[index];
                const shoppingColRef = collection(db, getPublicCollectionPath('shoppingList'));
                const itemDocRef = doc(shoppingColRef, item.id);
                
                await setDoc(itemDocRef, { purchased: !item.purchased }, { merge: true });
            } catch (e) {
                console.error("切換購物項目狀態失敗:", e);
                showModal('切換狀態失敗，請檢查連線。', 'error');
            }
        };

        // 刪除購物清單項目
        window.deleteShoppingItem = async (index) => {
            if (!isAuthReady || userId === 'anonymous') {
                showModal('請先登入或等待初始化完成。', 'warning');
                return;
            }
            if (!shoppingList[index]) return;

            // 替代 alert/confirm 的 UI 提示
            const confirmDelete = await showConfirmModal('確定要刪除此購物項目嗎？');
            if (!confirmDelete) return;
            
            try {
                const item = shoppingList[index];
                const shoppingColRef = collection(db, getPublicCollectionPath('shoppingList'));
                const itemDocRef = doc(shoppingColRef, item.id);
                await deleteDoc(itemDocRef);
            } catch (e) {
                console.error("刪除購物項目失敗:", e);
                showModal('刪除項目失敗，請檢查連線。', 'error');
            }
        };

        // 清空購物清單
        const clearShoppingList = async () => {
            if (!isAuthReady || userId === 'anonymous') {
                showModal('請先登入或等待初始化完成。', 'warning');
                return;
            }
            if (shoppingList.length === 0) return;

            const confirmClear = await showConfirmModal('確定要清除所有購物清單項目嗎？');
            if (!confirmClear) return;

            try {
                const shoppingColRef = collection(db, getPublicCollectionPath('shoppingList'));
                // 逐一刪除清單中的所有文件
                const batchPromises = shoppingList.map(item => {
                    return deleteDoc(doc(shoppingColRef, item.id));
                });
                await Promise.all(batchPromises);
                showModal('購物清單已清空。', 'success');
            } catch (e) {
                console.error("清空購物清單失敗:", e);
                showModal('清空清單失敗，請檢查連線。', 'error');
            }
        };

        // 儲存旅遊筆記
        const saveNotes = async (content) => {
            if (!isAuthReady || userId === 'anonymous') {
                console.warn("認證未就緒或匿名用戶，無法儲存筆記。");
                return;
            }
            try {
                const notesDocRef = doc(db, getPrivateDocPath('notes'));
                await setDoc(notesDocRef, { content: content }, { merge: true });
                // 不顯示 modal 提示，以避免頻繁打擾用戶
            } catch (e) {
                console.error("儲存筆記失敗:", e);
            }
        };


        // ===== UI 更新函式 =====

        // 更新飯店資訊區塊
        const updateHotelUI = () => {
            const hName = document.getElementById('h-name');
            const hDates = document.getElementById('h-dates');
            const hAddr = document.getElementById('h-addr');
            const copyBtn = document.getElementById('copy-addr-btn');
            
            if (hName) hName.textContent = hotel.name;
            if (hDates) hDates.textContent = hotel.dates;
            if (hAddr) hAddr.textContent = hotel.address;

            // 根據地址內容決定是否顯示複製按鈕
            if (copyBtn) {
                if (hotel.address && hotel.address !== '請點擊下方按鈕設定地址') {
                    copyBtn.classList.remove('hidden');
                } else {
                    copyBtn.classList.add('hidden');
                }
            }
            
            // 更新行程視圖中的 Day 1 資訊 (如果 Day 1 資訊存在)
            if (itinerary.length > 0) {
                itinerary[0].activities[1].description = `${hotel.name} Check-in`;
                if (appView === 'ITINERARY') {
                    renderItinerary();
                }
            }
        };

        // 更新購物清單摘要
        const updateShoppingSummary = () => {
            const pendingCount = shoppingList.filter(item => !item.purchased).length;
            const pendingCountEl = document.getElementById('pending-count');
            const summaryListEl = document.getElementById('shopping-list-summary');

            if (pendingCountEl) pendingCountEl.textContent = pendingCount;

            if (summaryListEl) {
                if (pendingCount === 0) {
                    summaryListEl.innerHTML = '<li class="text-gray-500 text-center py-2">清單為空</li>';
                } else {
                    const topItems = shoppingList
                        .filter(item => !item.purchased)
                        .slice(0, 3) // 只顯示前 3 項
                        .map(item => `<li class="truncate"><i data-lucide="dot" class="w-4 h-4 inline-block text-teal-500"></i>${item.name}</li>`)
                        .join('');
                    
                    const moreText = pendingCount > 3 ? `<li class="text-xs text-gray-500 mt-1">... 還有 ${pendingCount - 3} 項未完成</li>` : '';
                    
                    summaryListEl.innerHTML = topItems + moreText;

                    // 重新解析 lucide 圖標
                    lucide.createIcons();
                }
            }
        };

        // 匯率轉換器邏輯
        window.convertCurrency = (value, type, updateInput = true) => {
            const twdInput = document.getElementById('twdInput');
            const jpyInput = document.getElementById('jpyInput');
            const rateInfo = document.getElementById('rateInfo');

            // 確保輸入值是有效數字
            const num = parseFloat(value);
            if (isNaN(num)) return;

            if (type === 'twd') {
                const jpy = (num * hotel.rate).toFixed(2);
                if (updateInput && jpyInput) jpyInput.value = jpy;
            } else if (type === 'jpy') {
                const twd = (num / hotel.rate).toFixed(2);
                if (updateInput && twdInput) twdInput.value = twd;
            }

            if (rateInfo) rateInfo.textContent = `當前匯率: 1 TWD = ${hotel.rate.toFixed(2)} JPY`;
        };

        // ===== 視圖渲染函式 =====

        // 渲染行程總覽視圖
        function renderItinerary() {
            const container = document.getElementById('main-content');
            if (!container) return;

            // Day 導航
            const dayNav = itinerary.map(dayData => `
                <button 
                    class="px-4 py-2 rounded-full text-sm font-semibold transition duration-150 ${dayData.day === itineraryDay ? 'bg-teal-500 text-white shadow-lg' : 'bg-gray-700/50 text-gray-300 hover:bg-gray-700'}"
                    onclick="setItineraryDay(${dayData.day})"
                >
                    Day ${dayData.day}
                </button>
            `).join('');

            // 當前 Day 的內容
            const currentDayData = itinerary.find(d => d.day === itineraryDay);
            let dayContent = '';
            
            if (currentDayData) {
                const activities = currentDayData.activities.map(act => `
                    <div class="flex border-b border-gray-600/30 py-3 last:border-b-0">
                        <p class="font-mono text-sm text-teal-400 w-1/4 min-w-[70px]">${act.time}</p>
                        <p class="text-gray-200 font-medium w-3/4">${act.description}</p>
                    </div>
                `).join('');

                dayContent = `
                    <div class="p-4 bg-gray-700/20 rounded-xl mb-4 shadow-inner">
                        <h3 class="text-2xl font-extrabold text-teal-300 mb-1">Day ${currentDayData.day}</h3>
                        <p class="text-sm font-medium text-gray-400">${currentDayData.date}</p>
                    </div>
                    <div class="space-y-1">
                        ${activities}
                    </div>
                `;
            } else {
                 dayContent = '<p class="text-gray-500 text-center py-10">找不到該天的行程資料。</p>';
            }

            // 組合最終 HTML
            container.innerHTML = `
                <div class="flex space-x-3 mb-6 no-scrollbar overflow-x-auto pb-2">
                    ${dayNav}
                </div>
                <div>
                    ${dayContent}
                </div>
            `;
        }
        
        // 切換行程 Day
        window.setItineraryDay = (day) => {
            itineraryDay = day;
            renderItinerary();
        };

        // 渲染購物清單
        function renderShoppingList() {
            const container = document.getElementById('main-content');
            if (!container) return;

            const pendingCount = shoppingList.filter(item => !item.purchased).length;
            const completedCount = shoppingList.length - pendingCount;

            container.innerHTML = `
                <h3 class="text-2xl font-bold text-teal-300 mb-4">
                    購物清單總覽 
                    <span class="text-lg font-normal text-gray-400">
                        (${pendingCount} 待辦 / ${completedCount} 已完成)
                    </span>
                </h3>
                
                <!-- 輸入區塊 -->
                <div id="shopping-input-container" class="bg-gray-700/30 p-4 rounded-xl mb-4 flex space-x-3 shadow-inner">
                    <input type="text" id="new-shopping-item" placeholder="新增購物項目名稱..." class="flex-grow p-3 rounded-lg border-2 border-gray-600/50 bg-gray-800 text-white focus:border-teal-500 transition duration-150" onkeyup="if(event.key === 'Enter') { document.getElementById('add-shopping-btn').click(); }">
                    <button id="add-shopping-btn" onclick="addNewShoppingItem()" class="btn-primary flex-shrink-0 px-6 py-3 rounded-lg font-semibold text-sm shadow-md">
                        新增
                    </button>
                </div>
                
                <!-- 清單本體 -->
                <ul id="shopping-list-container" class="max-h-[50vh] overflow-y-auto pr-2 no-scrollbar">
                    <!-- 項目由 JS 填充 -->
                </ul>

                <!-- 底部控制按鈕 -->
                <div class="mt-6 pt-4 border-t border-gray-700/50 flex justify-between space-x-3">
                    <button id="show-hide-shopping-input-btn" onclick="toggleShoppingInput()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md transition duration-150">
                        隱藏輸入框
                    </button>
                    <button id="clear-shopping-list-btn" onclick="clearShoppingList()" class="btn-danger px-4 py-2 rounded-lg text-sm font-semibold shadow-md transition duration-150 hidden">
                        清除所有項目
                    </button>
                </div>
            `;

            // 渲染購物清單項目
            const listContainer = document.getElementById('shopping-list-container');
            if (!listContainer) return; // 安全檢查

            // 渲染購物清單項目
            let listHTML = '';
            shoppingList.forEach((item, index) => {
                // 使用唯一 ID 確保 Lucide 圖標正確渲染
                const iconId = `icon-${item.id || index}`;
                listHTML += `
                    <li class="flex justify-between items-center p-3 my-2 rounded-xl ${item.purchased ? 'bg-green-100/10 text-gray-400 line-through' : 'bg-gray-700/50'} transition duration-300 shadow-md">
                        <div class="flex items-center space-x-3">
                            <button onclick="toggleShoppingItem(${index})" class="text-xl p-1 rounded-full ${item.purchased ? 'text-teal-400' : 'text-gray-500 hover:text-teal-300'}">
                                <i data-lucide="${item.purchased ? 'check-circle' : 'circle'}" class="w-5 h-5"></i>
                            </button>
                            <span class="text-base font-medium">${item.name}</span>
                        </div>
                        <button onclick="deleteShoppingItem(${index})" class="text-red-400 hover:text-red-300 p-1 rounded-full">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </li>
                `;
            });

            listContainer.innerHTML = listHTML || '<p class="text-gray-500 text-center py-4">購物清單是空的！</p>';
            
            // 重新解析 lucide 圖標
            lucide.createIcons();
            
            // 處理底部按鈕的顯示/隱藏
            const shoppingInput = document.getElementById('new-shopping-item');
            const clearBtn = document.getElementById('clear-shopping-list-btn');
            const showBtn = document.getElementById('show-hide-shopping-input-btn');
            const inputContainer = document.getElementById('shopping-input-container');

            // 安全性檢查：如果任何一個控制元素不存在，則提前退出，避免 TypeError
            if (!shoppingInput || !clearBtn || !showBtn || !inputContainer) {
                console.error('購物清單控制元素遺失，無法設定按鈕狀態。');
                return;
            }

            if (shoppingList.length === 0) {
                // 清單為空：隱藏清除按鈕，隱藏輸入框，重置顯示/隱藏按鈕文字
                clearBtn.classList.add('hidden');
                inputContainer.classList.add('hidden');
                showBtn.textContent = '新增購物項目';
                shoppingInput.value = '';
            } else {
                // 清單非空：顯示清除按鈕
                clearBtn.classList.remove('hidden');

                // 根據輸入框的當前狀態設定顯示/隱藏按鈕的文字
                // 修正：如果輸入框是 hidden，按鈕文字應為 '顯示輸入框'
                if (inputContainer.classList.contains('hidden')) {
                    showBtn.textContent = '顯示輸入框';
                } else {
                    showBtn.textContent = '隱藏輸入框';
                }
            }
        }
        
        // 渲染旅遊筆記
        function renderNotes() {
            const container = document.getElementById('main-content');
            if (!container) return;

            container.innerHTML = `
                <h3 class="text-2xl font-bold text-teal-300 mb-4">我的旅遊筆記</h3>
                <p class="text-sm text-gray-400 mb-3">您的筆記會自動儲存。</p>
                <textarea 
                    id="notes-textarea" 
                    class="w-full h-[65vh] p-4 rounded-xl border-2 border-gray-600/50 bg-gray-800 text-white focus:border-teal-500 transition duration-150 resize-none" 
                    placeholder="在這裡寫下您的旅遊心得、注意事項或重要資訊..."
                >${notes}</textarea>
            `;

            // 設定事件監聽器，即時儲存筆記
            const notesTextarea = document.getElementById('notes-textarea');
            if (notesTextarea) {
                notesTextarea.addEventListener('input', (e) => {
                    notes = e.target.value;
                    saveNotes(notes);
                });
            }
        }

        // 切換主視圖
        function updateMainView() {
            // 重置導航按鈕的 active 狀態
            document.getElementById('btnItinerary')?.classList.remove('active');
            document.getElementById('btnShopping')?.classList.remove('active');
            document.getElementById('btnNotes')?.classList.remove('active');
            
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                // 清空內容，準備渲染新視圖
                mainContent.innerHTML = '';
            }

            switch (appView) {
                case 'ITINERARY':
                    document.getElementById('btnItinerary')?.classList.add('active');
                    renderItinerary();
                    break;
                case 'SHOPPING':
                    document.getElementById('btnShopping')?.classList.add('active');
                    renderShoppingList();
                    break;
                case 'NOTES':
                    document.getElementById('btnNotes')?.classList.add('active');
                    renderNotes();
                    break;
                default:
                    renderItinerary();
            }
        }

        // 設定並切換視圖
        window.setView = (view) => {
            appView = view;
            updateMainView();
        };

        // 新增購物項目
        window.addNewShoppingItem = () => {
            const input = document.getElementById('new-shopping-item');
            if (input && input.value.trim()) {
                addShoppingItem(input.value);
                input.value = ''; // 清空輸入框
                
                // 確保輸入框在新增後仍然顯示（如果它原本是被隱藏的）
                const inputContainer = document.getElementById('shopping-input-container');
                if (inputContainer && inputContainer.classList.contains('hidden')) {
                    toggleShoppingInput(true); // 強制顯示
                }
            }
        };

        // 切換購物清單輸入框顯示/隱藏
        window.toggleShoppingInput = (forceShow = false) => {
            const inputContainer = document.getElementById('shopping-input-container');
            const showBtn = document.getElementById('show-hide-shopping-input-btn');
            
            if (!inputContainer || !showBtn) return;
            
            if (forceShow || inputContainer.classList.contains('hidden')) {
                // 顯示輸入框
                inputContainer.classList.remove('hidden');
                showBtn.textContent = '隱藏輸入框';
                document.getElementById('new-shopping-item')?.focus();
            } else {
                // 隱藏輸入框
                inputContainer.classList.add('hidden');
                showBtn.textContent = '顯示輸入框';
            }
        };


        // ===== Modal 相關函式 =====

        // 顯示通用 Modal
        function showModal(message, type = 'info') {
            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) return;

            let bgColor, icon;
            if (type === 'success') {
                bgColor = 'bg-teal-500';
                icon = '<i data-lucide="check-circle" class="w-6 h-6 mr-2"></i>';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                icon = '<i data-lucide="x-circle" class="w-6 h-6 mr-2"></i>';
            } else if (type === 'warning') {
                bgColor = 'bg-amber-500';
                icon = '<i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i>';
            } else {
                bgColor = 'bg-gray-700';
                icon = '<i data-lucide="info" class="w-6 h-6 mr-2"></i>';
            }
            
            modalContainer.innerHTML = `
                <div class="flat-panel ${bgColor} text-white p-6 rounded-xl w-full max-w-sm shadow-2xl transform scale-95 transition-transform duration-300">
                    <div class="flex items-center mb-4">
                        ${icon}
                        <h4 class="text-xl font-bold">系統提示</h4>
                    </div>
                    <p class="mb-6">${message}</p>
                    <button onclick="closeModal()" class="w-full bg-white bg-opacity-30 hover:bg-opacity-50 font-semibold py-2 rounded-lg transition duration-150">
                        確定
                    </button>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            setTimeout(() => modalContainer.classList.add('opacity-100', 'scale-100'), 10);
            lucide.createIcons();
        }

        // 顯示確認 Modal (返回 Promise)
        function showConfirmModal(message) {
            return new Promise(resolve => {
                const modalContainer = document.getElementById('modal-container');
                if (!modalContainer) return resolve(false);

                const confirmAction = (result) => {
                    closeModal();
                    resolve(result);
                };

                modalContainer.innerHTML = `
                    <div class="flat-panel bg-gray-800 text-white p-6 rounded-xl w-full max-w-sm shadow-2xl transform scale-95 transition-transform duration-300">
                        <div class="flex items-center mb-4 text-amber-400">
                            <i data-lucide="alert-circle" class="w-6 h-6 mr-2"></i>
                            <h4 class="text-xl font-bold">請確認</h4>
                        </div>
                        <p class="mb-6 text-gray-300">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button onclick="confirmAction(false)" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition duration-150">
                                取消
                            </button>
                            <button onclick="confirmAction(true)" class="btn-danger px-4 py-2 rounded-lg font-semibold transition duration-150">
                                確定
                            </button>
                        </div>
                    </div>
                `;
                window.confirmAction = confirmAction; // 暴露給全局，讓 Modal 內部的點擊事件能呼叫
                modalContainer.classList.remove('hidden');
                setTimeout(() => modalContainer.classList.add('opacity-100', 'scale-100'), 10);
                lucide.createIcons();
            });
        }

        // 關閉 Modal
        window.closeModal = () => {
            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                modalContainer.classList.remove('opacity-100', 'scale-100');
                setTimeout(() => modalContainer.classList.add('hidden'), 300);
            }
        };

        // 顯示飯店設定 Modal
        window.showHotelModal = () => {
            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) return;

            modalContainer.innerHTML = `
                <div class="flat-panel bg-gray-800 text-white p-6 rounded-xl w-full max-w-lg shadow-2xl">
                    <h4 class="text-2xl font-bold text-teal-300 mb-4">設定飯店與日期</h4>
                    <div class="space-y-4">
                        <div>
                            <label for="modal-h-name" class="block text-sm font-medium mb-1 text-gray-300">飯店名稱</label>
                            <input type="text" id="modal-h-name" class="w-full p-3 rounded-lg border-2 border-gray-600/50 bg-gray-700 text-white focus:border-teal-500" value="${hotel.name === '請設定飯店名稱' ? '' : hotel.name}">
                        </div>
                        <div>
                            <label for="modal-h-addr" class="block text-sm font-medium mb-1 text-gray-300">飯店地址 (可複製用)</label>
                            <textarea id="modal-h-addr" class="w-full p-3 h-20 rounded-lg border-2 border-gray-600/50 bg-gray-700 text-white focus:border-teal-500">${hotel.address === '請點擊下方按鈕設定地址' ? '' : hotel.address}</textarea>
                        </div>
                        <div>
                            <label for="modal-h-dates" class="block text-sm font-medium mb-1 text-gray-300">旅遊日期 (e.g. 4/25 - 5/1)</label>
                            <input type="text" id="modal-h-dates" class="w-full p-3 rounded-lg border-2 border-gray-600/50 bg-gray-700 text-white focus:border-teal-500" value="${hotel.dates}">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="closeModal()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition duration-150">
                            取消
                        </button>
                        <button onclick="saveHotelSettings()" class="btn-primary px-4 py-2 rounded-lg font-semibold shadow-md">
                            儲存設定
                        </button>
                    </div>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            setTimeout(() => modalContainer.classList.add('opacity-100'), 10);
        };

        // 儲存飯店設定
        window.saveHotelSettings = () => {
            const name = document.getElementById('modal-h-name').value.trim() || '請設定飯店名稱';
            const address = document.getElementById('modal-h-addr').value.trim() || '請點擊下方按鈕設定地址';
            const dates = document.getElementById('modal-h-dates').value.trim() || 'YYYY/MM/DD - YYYY/MM/DD';

            hotel.name = name;
            hotel.address = address;
            hotel.dates = dates;

            closeModal();
            updateHotelUI();
            saveHotel();
        };

        // 顯示匯率設定 Modal
        window.showRateModal = () => {
            const modalContainer = document.getElementById('modal-container');
            if (!modalContainer) return;

            modalContainer.innerHTML = `
                <div class="flat-panel bg-gray-800 text-white p-6 rounded-xl w-full max-w-sm shadow-2xl">
                    <h4 class="text-2xl font-bold text-teal-300 mb-4">設定 TWD 兌 JPY 匯率</h4>
                    <p class="text-sm text-gray-400 mb-3">設定 1 TWD 可以兌換多少 JPY。</p>
                    <div class="flex items-center space-x-2">
                        <span class="text-lg font-medium">1 TWD =</span>
                        <input type="number" step="0.01" id="modal-rate-input" class="flex-grow p-3 rounded-lg border-2 border-gray-600/50 bg-gray-700 text-white focus:border-teal-500" value="${hotel.rate}">
                        <span class="text-lg font-medium">JPY</span>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="closeModal()" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold transition duration-150">
                            取消
                        </button>
                        <button onclick="saveRateSettings()" class="btn-primary px-4 py-2 rounded-lg font-semibold shadow-md">
                            儲存設定
                        </button>
                    </div>
                </div>
            `;
            modalContainer.classList.remove('hidden');
            setTimeout(() => modalContainer.classList.add('opacity-100'), 10);
        };

        // 儲存匯率設定
        window.saveRateSettings = () => {
            const rateInput = document.getElementById('modal-rate-input');
            const newRate = parseFloat(rateInput.value);

            if (isNaN(newRate) || newRate <= 0) {
                showModal('請輸入有效的正數匯率。', 'error');
                return;
            }

            hotel.rate = newRate;

            closeModal();
            convertCurrency(document.getElementById('twdInput')?.value || 0, 'twd'); // 更新轉換器顯示
            saveHotel();
        };

        // 複製地址到剪貼簿
        window.copyAddress = () => {
            const text = document.getElementById('h-addr').textContent;
            if(!text || text === '請點擊下方按鈕設定地址') {
                const originalText = document.getElementById('h-addr').textContent;
                document.getElementById('h-addr').textContent = "⚠️ 請先設定地址！";
                document.getElementById('h-addr').classList.add('red-accent');
                setTimeout(() => {
                    document.getElementById('h-addr').textContent = originalText;
                    document.getElementById('h-addr').classList.remove('red-accent');
                }, 2000);
                return;
            }
            
            // 複製到剪貼簿
            document.execCommand('copy', false, text);

            // 提供視覺回饋
            const originalText = document.getElementById('h-addr').textContent;
            document.getElementById('h-addr').textContent = "✅ 已複製到剪貼簿！ (1.5秒後恢復)";
            document.getElementById('h-addr').classList.add('teal-accent'); 
            setTimeout(() => {
                document.getElementById('h-addr').textContent = originalText;
                document.getElementById('h-addr').classList.remove('teal-accent');
            }, 1500);
        }

        // 程式初始化
        window.onload = () => {
            initializeFirebase(); // 初始化 Firebase，並在認證後啟動監聽器
            
            // 由於資料載入是異步的，這裡先顯示預設視圖，資料會透過 onSnapshot 更新
            updateMainView(); // 顯示預設的 ITINERARY 視圖 (DAY 1)
            
            // 設定匯率輸入框預設值
            document.getElementById('twdInput').value = 1000;
            convertCurrency(1000, 'twd', true); // 初始化轉換 1000 TWD
        };

    </script>
</body>
</html>
